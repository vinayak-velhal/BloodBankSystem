 @{
    ViewData["Title"] = "User Dashboard";
}

<!-- Dashboard Body -->
<div class="dashboard-bg">
    <div class="container-fluid m-0 p-0">
        <div class="image-container p-3" style="width:100%; height:350px; position: relative; overflow:hidden;">
            <img src="~/images/Background Image.jpg" alt="BloodBankHome" style="width:100%; height:100%; object-fit:cover;" />
            <div class="image-text" style="position: absolute; top: 50%; left: 17%; transform: translate(-50%, -50%);">
                <h3 class="text-danger"><strong>Save</br>Lives by</br>Donating Blood</strong></h3>
                <p>Together, we can ensure</br>timely blood availablity.</p>
                <a class="btn btn-danger text-light fw-semibold" asp-controller="Donor" asp-action="Index">Become a Donor</a>
            </div>
        </div>
        <div class="p-2 m-3 mt-0 text-center rounded" style="background-color: hsla(0, 100%, 95%, 0.6); box-shadow: 0px 1px 4px rgba(0,0,0,0.08);">
            <h2 class="m-0 text-decoration-underline" style="font-family: 'Montserrat', sans-serif; font-weight: 600; color: #8b0000">Welcome to Blood Bank</h2>
         </div>
         <div class="row m-4 mt-0">
             <div class="col">
                <div class="card">
                    <h5 class="card-header bg-danger bg-opacity-80 text-center" style="color: white;">Blood Inventory Overview</h5>
                    <div class="card-body text-center" style="height 410px;">
                        <canvas id="bloodPieChart" style="width: 410px; height: 410px; margin:auto">
                        </canvas>
                    </div>
                </div>
             </div>
            <div class="col">
                <div class="card">
                    <h5 class="card-header bg-danger bg-opacity-80 text-center" style="color: white;">Blood Stock Details</h5>
                    <div class="card-body p-1" style="height: 442px;">
                        <div class="row row-cols-2">
                            <div class="col pe-1">
                                <p class="text-center fw-semibold m-0">Available</p>
                                <table class="table table-bordered text-center mb-2">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Blood Group</th>
                                            <th>Total Units</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pivotAvailable"></tbody>
                                </table>
                            </div>
                            <div class="col ps-1">
                                <p class="text-center fw-semibold m-0">Expired</p>
                                <table class="table table-bordered text-center mb-2">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Blood Group</th>
                                            <th>Total Units</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pivotExpired"></tbody>
                                </table>
                                <div>
                                    <small class="d-flex justify-content-center align-items-center">
                                        <div style="height:13px; width:13px; background-color:rgba(255,0,0,0.4); margin-right: 8px"></div>
                                        <div> = Expired</div>
                                    </small>
                                </div>
                            </div>
                        </div>                       

                    </div>
                </div>
            </div>
         </div>
    </div>
</div
<!-- Add hover and smooth styles -->
<style>
    .hover-card 
    {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }

    .hover-card:hover 
    {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
</style>

 <!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    @section Scripts
    {
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                $(document).ready(function () {
                    $.getJSON("/Dashboard/GetBloodInventoryData", function (data) {
                        const labels = data.map(item => item.bloodGroup.bloodGroup);
                        const values = data.map(item => item.totalUnits);
                        const ctx = document.getElementById("bloodPieChart").getContext("2d");
                        new Chart(ctx, {
                            type: "pie", data: { labels: labels, datasets: [{ data: values, backgroundColor: ["#007bff", "#6610f2", "#28a745", "#dc3545", "#ffc107", "#17a2b8", "#6f42c1", "#fd7e14"] }] },
                            options: {
                                plugins: {
                                    legend: { position: "bottom" }, title: { display: true, text: "Available Blood Units by Group" }
                                }

                            }
                        });
                    });
                });
            </script>
    
            <script>
                // Define all blood groups
                const allBloodGroups = ["A+", "A-", "B+", "B-", "O+", "O-", "AB+", "AB-"];

                $.getJSON("/Dashboard/GetBloodInventoryData", function (data) {

                    $("#pivotAvailable").empty();
                    $("#pivotExpired").empty();

                    const availableMap = {};
                    const expiredMap = {};

                    // Initialize all blood groups with 0
                    allBloodGroups.forEach(bg => {
                        availableMap[bg] = 0;
                        expiredMap[bg] = 0;
                    });

                    // Fill actual data
                    data.forEach(item => {
                        let bg = item.bloodGroup.bloodGroup;
                        let units = item.totalUnits;
                        let status = (item.status || item.bloodGroup.status || "")
                            .toString().trim().toLowerCase();

                        if (status === "expired") {
                            expiredMap[bg] = units;
                        } else {
                            availableMap[bg] = units;
                        }
                    });

                    // Render Available Table
                    allBloodGroups.forEach(bg => {
                        $("#pivotAvailable").append(
                            `<tr><td>${bg}</td><td>${availableMap[bg]}</td></tr>`
                        );
                    });

                    // Render Expired Table
                    allBloodGroups.forEach(bg => {
                        $("#pivotExpired").append(
                            `<tr>
                                <td style="background-color:rgba(255,0,0,0.4); color:white;">${bg}</td>
                                <td style="background-color:rgba(255,0,0,0.4); color:white;">${expiredMap[bg]}</td>
                            </tr>`
                        );
                    });
                });
            </script>
    }

